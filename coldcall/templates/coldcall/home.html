{% include 'coldcall/base.html' %}
<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'coldcall/style.css' %}">
    <link rel="stylesheet" href="{% static 'coldcall/home.css' %}">
    <title>Home</title>
</head>
<body>

{% if user.is_authenticated %}
    <h1>Welcome, {{ user.username }}! </h1>

    <!-- Class Filter Dropdown -->
    <div class="filter-container">
        <form method="get">
            <label for="class_id">Select Class:</label>
            <select id="class_id" name="class_id" onchange="this.form.submit()">
                <option value="">All Classes</option>
                {% for class in classes %}
                    <option value="{{ class.id }}" {% if selected_class and class.id == selected_class.id %}selected{% endif %}>
                        {{ class.class_name }}
                    </option>
                {% endfor %}
            </select>
        </form>

        <!-- Archive Button -->
        {% if selected_class and not selected_class.is_archived %}
            <form method="post" action="{% url 'home' %}">
                {% csrf_token %}
                <input type="hidden" name="class_id" value="{{ selected_class.id }}">
                <button type="submit">Archive Class</button>
            </form>
        {% endif %}
    </div>
    
    <!-- Randomizer Button -->
    <form method="get" action="{% url 'randomizer' %}">
        <input type="hidden" name="class_id" value="{{ selected_class.id }}">
        <button type="submit">Randomize Students</button>
    </form>

    <!-- Sort Students -->
    <div class="sort-container">
        <form method="get">
            <label for="sort">Sort Students:</label>
            <select id="sort" name="sort" onchange="this.form.submit()">
                <option value="" {% if not sort %}selected{% endif %}>Default</option>
                <option value="first_name" {% if sort == 'first_name' %}selected{% endif %}>First Name</option>
                <option value="last_name" {% if sort == 'last_name' %}selected{% endif %}>Last Name</option>
                <option value="seating" {% if sort == 'seating' %}selected{% endif %}>Seating</option>
                <option value="total_calls" {% if sort == 'total_calls' %}selected{% endif %}>Total Calls</option>
                <option value="absent_calls" {% if sort == 'absent_calls' %}selected{% endif %}>Absent Calls</option>
                <option value="total_score" {% if sort == 'total_score' %}selected{% endif %}>Total Score</option>
            </select>
            <!-- Hidden input to keep class_id when sorting -->
            <input type="hidden" name="class_id" value="{{ selected_class.id }}">
            <!-- Hidden input to keep search queries when sorting -->
            <input type="hidden" name="search_first_name" value="{{ first_name }}">
            <input type="hidden" name="search_last_name" value="{{ last_name }}">
            <input type="hidden" name="search_usc_id" value="{{ usc_id }}">
        </form>
    </div>

    <!-- Search Students -->
    <div class = "search-container">
        <form method="get">
            <label for="search">Search Students:</label>
            <input type="text" id="search_first_name" name="search_first_name" value="{{ first_name }}" placeholder="First Name">
            <input type="text" id="search_last_name" name="search_last_name" value="{{ last_name }}" placeholder="Last Name">
            <input type="text" id="search_usc_id" name="search_usc_id" value="{{ usc_id }}" placeholder="USC ID">
            <!-- Hidden input to keep class_id when searching -->
            <input type="hidden" name="class_id" value="{{ selected_class.id }}">
            <!-- Hidden input to keep sort when searching -->
            <input type="hidden" name="sort" value="{{ sort }}">
            <button type="submit" onclick="this.form.submit()">Search</button>
        </form>
    </div>

    <!-- Display Students for the Selected Class -->
    <div class="student-table-container">
        <table class="student-table">
            <thead>
                <tr>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Seating</th>
                    <th>Total Calls</th>
                    <th>Absent Calls</th>
                    <th>Total Score</th>
                    <th>Actions</th>
                    <th>Edit</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                    <tr>
                        <td>{{ student.first_name }}</td>
                        <td>{{ student.last_name }}</td>
                        <td>{{ student.seating }}</td>
                        <td>{{ student.total_calls }}</td>
                        <td>{{ student.absent_calls }}</td>
                        <td>{{ student.total_score }}</td>
                        <td><a href="{% url 'student_metrics' student.id %}">View Metrics</a></td>
                        <td><a href="{% url 'addedit_student_manual_with_id' student.id %}">Edit</a></td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8">No students found for this class.</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Logout form -->
    <form action="{% url 'logout' %}" method="post">
        {% csrf_token %}
        <button type="submit">Logout</button>
    </form>

{% else %}
    <p>You need to <a href="{% url 'login' %}">log in</a> to view your classes and students.</p>
{% endif %}

</body>
</html>